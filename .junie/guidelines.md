Cloud Client Config – Руководство по разработке
Всегда отвечай на русском

Область применения
Эти заметки фиксируют специфичные для проекта детали, помогающие опытным контрибьюторам работать эффективно. Они сфокусированы на сборке/конфигурации, тестировании и практиках разработки, характерных именно для этого репозитория.

Обзор репозитория
- Назначение: Быстро развернуть и запустить клиентский стек в инфраструктурной среде с использованием Docker Compose.
- Точки входа:
  - generate-compose.sh – генерирует docker-compose.yml из docker-compose.template.yml и .env.
  - update.sh – сквозной сценарий обновления: тянет изменения репозитория, подтягивает образы, генерирует compose, поднимает сервисы, ждёт, пока bd-proxy-$BD_PROXY_ID станет здоровым, затем запускает миграции внутри контейнера.
- Удобные скрипты из package.json:
  - npm run generate-docker-compose → ./generate-compose.sh
  - npm run start → npm run generate-docker-compose && docker compose up -d
  - npm run update → ./update.sh

Инструкции по сборке/конфигурации
Предварительные требования (локально или на целевом сервере):
- Docker Engine 24+ и Docker Compose v2 (docker compose …)
- bash, coreutils, grep, sed
- envsubst (из GNU gettext) – используется в generate-compose.sh
- git и npm (npm нужен только для запуска предоставленных скриптов; Node как рантайм иначе не используется)

Обязательная среда (.env):
Минимально необходимы следующие переменные для успешной генерации compose и запуска:
- BD_PROXY_ID – целочисленный идентификатор клиентского инстанса. Используется для именования сервисов/контейнеров (db-$BD_PROXY_ID, bd-proxy-$BD_PROXY_ID).
- IMAGE_TAG – тег образа для kreditpro-proxy-bd (например, latest или релизный тег).
- TZ – строка часового пояса (например, Europe/Moscow), прокидывается внутрь контейнеров.
Дополнительные переменные могут использоваться нижележащими сервисами или в вашей среде (см. примеры в readme.md):
- MYSQL_HOST, API_PROXY_BD_SERVER_PORT – упоминаются в документации/инфраструктуре, но не проверяются скриптами.

Как работает рендеринг compose:
- generate-compose.sh выполняет:
  1) загрузку .env (завершается ошибкой, если BD_PROXY_ID не задан),
  2) предварительную замену в ключах сервисов и в container_name вхождений db-${BD_PROXY_ID} и bd-proxy-${BD_PROXY_ID} (sed), чтобы буквальные ключи получили числовой ID (envsubst ненадежно подставляет переменные внутри ключей compose),
  3) запуск envsubst над результатом для подстановки оставшихся ${VAR},
  4) запись docker-compose.yml.
- Необязательная поддержка promtail: если существует traefik-config/promtail-config.yml, он будет отрендерен в traefik-config/promtail-config.rendered.yml через envsubst. В репозитории этот файл по умолчанию отсутствует; шаг пропускается, если файла нет.

Подробности работы update.sh:
- Пишет логи в Update.log в корне репозитория (stdout/stderr перенаправлены).
- Сначала пытается выполнить git pull (ошибка не фатальна).
- Загружает .env и вычисляет CONTAINER_NAME="bd-proxy-${BD_PROXY_ID}".
- Выполняет docker compose pull (по возможности), чтобы заранее подтянуть образы.
- npm run start: генерирует compose и поднимает сервисы в фоне (detached).
- Ждёт до ~60 секунд (30 × 2 с), пока контейнер bd-proxy не перейдёт в состояние running.
- Запускает миграции внутри контейнера bd-proxy командой: docker exec -i "$CONTAINER_NAME" /bin/sh -c "npm run migrate-run".
  - Предполагается, что образ kreditpro-proxy-bd содержит npm-скрипт migrate-run. Если ваш образ изменится, убедитесь, что этот скрипт остаётся доступным, или обновите сценарий соответствующим образом.

Сеть/тома
- В compose определена пользовательская мостовая сеть mynetwork с подсетью 10.10.30.0/24.
- Сервис MySQL по умолчанию публикует 3307:3306 и монтирует:
  - Именованный том fnt-db для постоянных данных
  - ./mysql.cnf в расположения конфигурации MySQL
  - ./scripts в /docker-entrypoint-initdb.d (необязательно; при необходимости добавьте туда init-скрипты)

Информация о тестировании
Модель тестов (на bash):
- В этом репозитории нет выделенного тестового фреймворка. Для быстрой проверки используйте небольшие bash-скрипты, которые запускают generate-compose.sh с контролируемым .env и проверяют сгенерированный docker-compose.yml.
- Держите тесты эфемерными (не коммитьте их), если только вы не вводите формальную структуру тестов. CI/CD в рамках этого репозитория пока не рассматривается.

Как запускать тесты локально:
1) Подготовьте контролируемый .env и запустите генератор:
   - Примерные значения для проверки:
     BD_PROXY_ID=12
     TZ=Europe/Moscow
     IMAGE_TAG=latest
2) Запустите генератор и проверьте результат. Для удобства вот последовательность, которую можно вставить в вашу оболочку:
   cp -a . ._backup >/dev/null 2>&1 || true
   cat > .env <<'ENV'
   BD_PROXY_ID=12
   TZ=Europe/Moscow
   IMAGE_TAG=latest
   ENV
   ./generate-compose.sh
   test -f docker-compose.yml
   grep -q "container_name: db-12" docker-compose.yml
   grep -q "container_name: bd-proxy-12" docker-compose.yml
   grep -q "image: kreditpro.org:445/kreditpro/kreditpro-proxy-bd:latest" docker-compose.yml
   echo "compose generation OK"
   # cleanup
   rm -f docker-compose.yml .env
   rm -rf ._backup

Рекомендации по добавлению новых тестов:
- Создайте временный bash-скрипт, который:
  - Записывает контролируемый .env с явными BD_PROXY_ID, TZ, IMAGE_TAG.
  - Вызывает ./generate-compose.sh.
  - Ищет в docker-compose.yml ожидаемые подстановки (имена сервисов и тег образа) через grep.
  - Восстанавливает любые существовавшие ранее docker-compose.yml и .env или удаляет созданные им файлы.
- Если вам необходимо «сухо» проверить логику update.sh без Docker, можно частично прогнать шаги, установив BD_PROXY_ID и подменив docker/grep небольшими обёртками на PATH во временной среде, но лучше не коммитить такую обвязку.

Примечания и подводные камни:
- envsubst должен быть установлен; при его отсутствии generate-compose.sh завершится с ошибкой. В Debian/Ubuntu: apt-get install -y gettext-base.
- BD_PROXY_ID обязателен. Генератор завершится раньше, если он не указан в .env.
- Если вы добавляете новые переменные в docker-compose.template.yml, задокументируйте их и задайте разумные значения по умолчанию или валидируйте в generate-compose.sh.
- update.sh предполагает наличие Docker Compose v2 (docker compose). Если есть только docker-compose v1, установите v2 или адаптируйте сценарий.
- Миграции: скрипт обновления полагается на npm-скрипт внутри контейнера bd-proxy. При обновлении образов убедитесь, что требуемый скрипт публикуется.

Стиль и соглашения по коду:
- Shell-скрипты:
  - Используйте set -e (и -u/-o pipefail при необходимости), чтобы «падать» быстро.
  - По возможности делайте сценарии идемпотентными; не оставляйте временных артефактов в рабочем каталоге.
  - Предпочитайте явные проверки и информативные сообщения об ошибках (как уже сделано в generate-compose.sh).
- Compose:
  - Держите имена сервисов детерминированными и производными от BD_PROXY_ID, чтобы избегать коллизий между окружениями.
  - Ротация логов уже настроена через драйвер json-file с ограничениями по размеру/количеству файлов; сохраняйте или расширяйте при необходимости.

Верифицированный пример (вручную воспроизведённый при написании документа):
- Используя пример .env (BD_PROXY_ID=12, TZ=Europe/Moscow, IMAGE_TAG=latest), ./generate-compose.sh сгенерировал docker-compose.yml, содержащий:
  - container_name: db-12
  - container_name: bd-proxy-12
  - image: kreditpro.org:445/kreditpro/kreditpro-proxy-bd:latest
- После проверки временные файлы были удалены, чтобы сохранить чистоту репозитория.

Хозяйственные замечания
- Не коммитьте артефакты, специфичные для окружения (docker-compose.yml, .env, Update.log). Держите их локально.
- При добавлении новых шаблонов конфигурации убедитесь, что они рендерятся через envsubst, и предусмотрите понятные предупреждения, если отсутствуют необязательные файлы (шаблон, применённый для promtail).
